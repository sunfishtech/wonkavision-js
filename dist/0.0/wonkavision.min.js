/*  wonkavision.js, version 0.0.1

Copyright (c) 2011 [your name here]

Permission is hereby granted, free of charge, to any person
obtaining a copy of this software and associated documentation
files (the "Software"), to deal in the Software without
restriction, including without limitation the rights to use,
copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the
Software is furnished to do so, subject to the following
conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
OTHER DEALINGS IN THE SOFTWARE.
------------------------------------------------------------------*/
(function(){var e=function(){},d=function(b){null==b&&(b={});this.url=b.url||"";this.facts={};this.aggregations={}};d.prototype.query=function(b){null==b&&(b={});return new e.Query(this,b)};d.prototype.execute=function(b,c){var a,h;h=c.raw;a=c.error||function(){};this.get(c.facts?"facts":"query",b.toParams(),function(a){if(null!=a.json.error)return c.error(a.json.error);a=h?a:c.facts?a.json.data:new e.Cellset(a.json,b);return c.success(a)},a);return this};d.prototype.get=function(b,c,a,h){var d;d=
this.url+("/"===this.url.substr(-1)?"":"/");return e.Remote.get(d+b,{data:c,success:a,error:h})};e.Client=d;this.Wonkavision=e;this.Wonkavision.AXIS_NAMES=["columns","rows","pages","chapters","sections"]}).call(this);
(function(){this.Wonkavision.Utilities={keyToDate:function(e,d){var b;null==d&&(d=!0);e=e.toString();b=""+e.slice(0,4)+"-"+e.slice(4,6)+"-"+e.slice(6,8);b=moment(b);return d?b._d:b},dateToKey:function(e){null==e&&(e=moment());return parseInt(moment(e).format("YYYYMMDD"))},beginningOfMonth:function(e){null==e&&(e=new Date);return moment(e).date(1)._d},quarter:function(e){null==e&&(e=new Date);return parseInt(moment(e).month()/3)+1},beginningOfQuarter:function(e){var d;null==e&&(e=new Date);e=moment(e);
d=e.month()%3;return e.add("months",-1*d).date(1)._d},beginningOfYear:function(e){null==e&&(e=new Date);return moment(e).dayOfYear(1)._d},dateRange:function(e,d,b){null==b&&(b=!1);e=[e,d];return b?_.map(e,this.dateToKey):e},timeWindow:function(e,d,b,c){null==c&&(c=!1);d=moment(e).add(d,-1*b)._d;e=moment(e);return this.dateRange(d,e,c)},mtd:function(e,d){var b;null==d&&(d=!1);b=this.beginningOfMonth(e);return this.dateRange(b,e,d)},ytd:function(e,d){var b;null==d&&(d=!1);b=this.beginningOfYear(e);
return this.dateRange(b,e,d)},qtd:function(e,d){var b;null==d&&(d=!1);b=this.beginningOfQuarter(e);return this.dateRange(b,e,d)}}}).call(this);
(function(){var e=this.Wonkavision,d=function(){};d.prototype.xhr=function(b){b=this.createSettings(b.url,b);b.ajax=b.xhr();if(b.ajax)return this.prepareUrl(b),b.ajax.open(b.type,b.url,b.async),b.ajax.send(b.data||null),this.httpData(b)};d.prototype.prepareUrl=function(b){if("GET"===b.type&&b.data)return b.url+=/\?/.test(b.url)?"&":"?",b.url+=this.toParams(b.data),b.data=null};d.prototype.createSettings=function(b,c){null==c&&(c={});return{url:b,data:c.data||"",success:c.success||function(){},error:c.error||
function(){},type:c.type||"GET",async:c.async||!0,xhr:function(){return new window.XMLHttpRequest}}};d.prototype.toParams=function(b){var c,a,h;null==b&&(b={});a=[];for(c in b)h=b[c],a.push(""+c+"="+h);return encodeURI(a.join("&"))};d.prototype.httpData=function(b){return b.ajax.onreadystatechange=function(){var c;if(4===b.ajax.readyState){try{c=JSON.parse(b.ajax.responseText)}catch(a){console.log("Could not parse response ("+b.ajax.responseText+") as JSON:"+a)}c={xml:b.ajax.responseXML,text:b.ajax.responseText,
json:c};/(2..)/.test(b.ajax.status)?b.success.call(b.ajax,c):(console.log("There was an error processing a Wonkavision data request:"+b.ajax.statusText),b.error&&b.error.call(null,b.ajax.statusText));return c}return null}};e.Remote=d;this.Wonkavision.Remote.ajax=function(b){return(new d).xhr(b)};this.Wonkavision.Remote.get=function(b,c){c.url=b;return(new d).xhr(c)};this.Wonkavision.Remote.post=function(b,c){c.url=b;c.type="POST";return(new d).xhr()}}).call(this);
(function(){var e=this.Wonkavision,d=function(b,c){this.name=b;null==c&&(c={});var a=this.isFact,h=this;this.isFact=function(){return a.apply(h,arguments)};this.operator=c.operator||"eq";this.memberType=c.memberType||"dimension";this.value=c.value;this.attributeName=c.attributeName||(this.isDimension?"key":"count");this.operators="eq ne gt gte lt lte in nin".split(" ")};d.prototype.isDimension=function(){return"dimension"===this.memberType};d.prototype.isMeasure=function(){return"measure"===this.memberType};
d.prototype.isFact=function(){return"fact"===this.memberType};d.prototype.toString=function(){return[this.memberType,this.name,this.attributeName,this.operator,this.value.toString()].join("::")};d.prototype.parse=function(b,c){var a;null==c&&(c="::");a=b.split(c);if("dimension"===a[0]||"measure"===a[0]||"fact"===a[0])this.memberType=a.shift();this.name=a.shift();this.attributeName=a.shift()||this.attributeName;this.operator=a.shift()||this.operator;this.value=a.shift()||this.value;return this};d.prototype.withValue=
function(b){this.value=b;return this};e.Filter=d;this.Wonkavision.Filter.parse=function(b,c){null==c&&(c="::");return(new d("")).parse(b,c)}}).call(this);
(function(){var e=this.Wonkavision,d=function(b,c){this.name=b;null==c&&(c={});this.memberType=c.memberType||"dimension";this.value=c.value;this.attributeName=c.attributeName||(this.isDimension?"key":"count");this.order="asc"};d.prototype.isDimension=function(){return"dimension"===this.memberType};d.prototype.isMeasure=function(){return"measure"===this.memberType};d.prototype.isFact=function(){return"fact"===this.membertype};d.prototype.toString=function(){return[this.memberType,this.name,this.attributeName,
this.order].join("::")};d.prototype.parse=function(b,c){var a;null==c&&(c="::");a=b.split(c);if("dimension"===a[0]||"measure"===a[0]||"fact"===a[0])this.memberType=a.shift();this.name=a.shift();this.attributeName=a.shift()||this.attributeName;this.order=a.shift()||this.order;return this};e.MemberReference=d;this.Wonkavision.MemberReference.parse=function(b,c){null==c&&(c="::");return(new d("")).parse(b,c)}}).call(this);
(function(){var e,d,b=[].slice;e=this.Wonkavision.Filter;d=this.Wonkavision.MemberReference;var c=this.Wonkavision,a=function(b,a){var c,d,e,g;this.client=b;null==a&&(a={});g=Wonkavision.AXIS_NAMES;d=0;for(e=g.length;d<e;d++)c=g[d],this[c]=this.select(c);this.listDelimiter=a.listDelimiter||"|";this.axes=[];this.filters=[];this.selectedMeasures=[];this.order_by_attributes=[];this.selected_attributes=[];this.topFilter=null;g=Wonkavision.AXIS_NAMES;d=0;for(e=g.length;d<e;d++)if(c=g[d],null!=a[c])this[c](a[c]);
null!=a.measures&&this.measures(a.measures);null!=a.where&&this.where(a.where);null!=a.from&&this.from(a.from);null!=a.order&&this.order(a.order);null!=a.attributes&&this.attributes(a.attributes);null!=a.top&&this.top(a.top);this.originalQuery=a};a.prototype.cube=function(a){this.cubeName=a;return this};a.prototype.from=function(a){this.cubeName=a;return this};a.prototype.measures=function(){var a;a=1<=arguments.length?b.call(arguments,0):[];this.selectedMeasures=this.selectedMeasures.concat(_.flatten(a));
return this};a.prototype.where=function(a){var b,c;null==a&&(a={});this.filters=this.filters.concat(function(){var d;d=[];for(b in a)c=a[b],d.push(e.parse(b,".").withValue(c));return d}());return this};a.prototype.order=function(){var a,c;c=1<=arguments.length?b.call(arguments,0):[];this.order_by_attributes=this.order_by_attributes.concat(function(){var b,e,k,g;k=_.flatten(c);g=[];b=0;for(e=k.length;b<e;b++)a=k[b],g.push(d.parse(a,"."));return g}());return this};a.prototype.attributes=function(){var a,
c;c=1<=arguments.length?b.call(arguments,0):[];this.selected_attributes=this.selected_attributes.concat(function(){var b,e,k,g;k=_.flatten(c);g=[];b=0;for(e=k.length;b<e;b++)a=k[b],g.push(d.parse(a,"."));return g}());return this};a.prototype.top=function(a){var b;this.topFilter={};this.topFilter.count=a.count;this.topFilter.dimension=a.dimension;this.topFilter.measure=a.measure;this.topFilter.exclude=_.compact(_.flatten([a.exclude]));if(a.where){var c=this.topFilter,d,k;d=a.where;k=[];for(b in d)a=
d[b],k.push(e.parse(b,".").withValue(a));return c.filters=k}};a.prototype.toParams=function(){var a,b,c,d,e;b={from:this.cubeName};1>this.selectedMeasures.length||(b.measures=this.selectedMeasures.join(this.listDelimiter));if(!(1>this.filters.length)){c=this.listDelimiter;var g,f;g=this.filters;f=[];d=0;for(e=g.length;d<e;d++)a=g[d],f.push(a.toString());b.filters=f.join(c)}if(!(1>this.order_by_attributes.length)){c=this.listDelimiter;g=this.order_by_attributes;f=[];d=0;for(e=g.length;d<e;d++)a=g[d],
f.push(a.toString());b.order=f.join(c)}if(!(1>this.selected_attributes.length)){c=this.listDelimiter;g=this.selected_attributes;f=[];d=0;for(e=g.length;d<e;d++)a=g[d],f.push(a.toString());b.attributes=f.join(c)}e=Wonkavision.AXIS_NAMES;c=0;for(d=e.length;c<d;c++)a=e[c],this.getAxis(a)&&(b[a]=this.getAxis(a).join(this.listDelimiter));if(null!=this.topFilter&&(b.top_filter_count=this.topFilter.count,b.top_filter_dimension=this.topFilter.dimension,null!=this.topFilter.measure&&(b.top_filter_measure=
this.topFilter.measure),null!=this.topFilter.exclude&&(b.top_filter_exclude=this.topFilter.exclude.join(this.listDelimiter)),this.topFilter.filters)){c=this.listDelimiter;g=this.topFilter.filters;f=[];d=0;for(e=g.length;d<e;d++)a=g[d],f.push(a.toString());b.top_filter_filters=f.join(c)}b.from=this.cubeName;return b};a.prototype.toString=function(){return toHash().toString()};a.prototype.execute=function(a){null==a&&(a={});return this.client.execute(this,a)};a.prototype.getAxis=function(a){return this.axes[Wonkavision.AXIS_NAMES.indexOf(a)]};
a.prototype.select=function(a){var c=this;return function(){var d,e;d=1<=arguments.length?b.call(arguments,0):[];e=Wonkavision.AXIS_NAMES.indexOf(a);0<=e&&(c.axes.length>e&&(d=c.axes[e].concat(d)),c.axes[e]=_.flatten(d));return c}};c.Query=a}).call(this);
(function(){var e,d,b,c,a,h,p,j,l={}.hasOwnProperty,k=function(a,b){function c(){this.constructor=a}for(var d in b)l.call(b,d)&&(a[d]=b[d]);c.prototype=b.prototype;a.prototype=new c;a.__super__=b.prototype;return a};h=this.Wonkavision;var g=function(a,b){var c,d,e,h,j,f,p,l,k,m=this;this.cellset=a;null==b&&(b={});this.axes=_.map(this.cellset.axes,function(a){return m[a.name]=new g.Axis(a.name,a.dimensions.slice(0),m)});(this.measuresAxis=b.measuresAxis||b.measuresOn)||(this.measuresAxis=this.isFlat?
"rows":"columns");this.initializeAxes();this.seriesCells={};this.isFlat=2>this.axes.length?!0:!1;p=this.cellset.cells;for(e in p){d=p[e];l=this.axes;j=0;for(f=l.length;j<f;j++)c=l[j],c.registerCell(d);null!=this.seriesDimension&&(c=d.key[this.seriesDimension.keyIndex],c=(h=this.seriesCells)[c]||(h[c]=[]),c.push(d))}null!=this.measuresAxis&&null!=(k=this[this.measuresAxis])&&k.appendMeasures()};g.prototype.initializeAxes=function(){var a,b,c,d,e;d=this.axes;e=[];b=0;for(c=d.length;b<c;b++)a=d[b],e.push(a.initialize());
return e};g.prototype.pivot=function(){var a;a=this.rows;this.rows=this.columns;return this.columns=a};g.prototype.createDataTable=function(){return new d(this)};g.prototype.createCell=function(a,b,c){null==c&&(c=null);return new p(a,b,c)};h.PivotTable=h=g;var f=this.Wonkavision,m=function(a,b){null==b&&(b={});this.seriesSource=b.seriesSource||b.seriesFrom||(1<a.measureNames.length?"measures":"rows");m.__super__.constructor.call(this,a,b)};k(m,h);m.prototype.initializeAxes=function(){this.xAxisDimension=
this.columns.dimensions.pop();this.seriesDimension="measures"!==this.seriesSource&&null!=this[this.seriesSource]?this[this.seriesSource].dimensions.pop():void 0;"measures"===this.seriesSource&&(this.measuresAxis=null);return m.__super__.initializeAxes.call(this)};m.prototype.createCell=function(a,b){return new e(a,b)};f.ChartTable=m;h=this.Wonkavision.PivotTable;f=function(a){var b,c,d=this;this.pivot=a;this.rowMembers=null!=(b=this.pivot.rows)?b.members.nonEmpty().partitionH():void 0;this.columnMembers=
null!=(c=this.pivot.columns)?c.members.nonEmpty().partitionV():void 0;this.rows=[];_.map(this.rowMembers,function(a){return d.addRow(a)})};f.prototype.addRow=function(a){return this.rows.push(this.createRow(a))};f.prototype.createRow=function(a){return new j(this,a)};h.DataTable=d=f;h=this.Wonkavision.PivotTable;f=function(a,b){var c=this;this.table=a;this.rowMembers=b;this.pivot=this.table.pivot;this.cells=[];this.rowMember=_.isArray(this.rowMembers)?_.last(this.rowMembers):this.rowMembersr;this.pivot.isFlat&&
"rows"===this.pivot.measuresAxis?_.map(this.pivot.cellset.measureNames,function(a){return c.addCell([c.rowMember],a)}):this.pivot.columns&&!this.pivot.columns.isEmpty?_.map(this.pivot.columns.members.nonEmpty().leaves(),function(a){return c.addCell([c.rowMember,a])}):this.addCell([this.rowMember])};f.prototype.addCell=function(a,b){return this.cells.push(this.pivot.createCell(this,a,b))};h.TableRow=j=f;h=this.Wonkavision.PivotTable;f=function(a,b,c){var d,e,h;this.row=a;this.keyMembers=b;this.measureName=
c;this.pivot=this.row.pivot;this.cell=this.cellFor(this.keyMembers);this.measureName||(this.measureName=this.findMeasureName(this.keyMembers));this.measure=null!=(d=this.cell)?d[this.measureName]:void 0;this.value=null!=(e=this.measure)?e.value:void 0;this.formattedValue=null!=(h=this.measure)?h.formattedValue:void 0};f.prototype.cellFor=function(a){a=_.flatten(_.map(_.sortBy(_.compact(a),function(a){return a.keyIndex}),function(a){return a.cellKey()}));return this.pivot.cellset.cells[a]};f.prototype.findMeasureName=
function(a){var b;return(null!=(b=_.find(a,function(a){return null!=(null!=a?a.measureName:void 0)}))?b.measureName:void 0)||this.pivot.cellset.measureNames[0]};h.TableCell=p=f;h=this.Wonkavision.PivotTable;f=function(a,b){var c,d=this;this.row=a;this.keyMembers=b;this.pivot=this.row.pivot;"measures"===this.pivot.seriesSource?this.series=_.map(this.pivot.cellset.measureNames,function(a){return{name:a,data:d.seriesFromMeasure(b,a)}}):null!=this.pivot.seriesDimension&&(c=_.filter(this.pivot.seriesDimension.members,
function(a){return null!=d.pivot.seriesCells[a.key]}),this.series=_.map(c,function(a){return{name:a.caption,data:d.seriesFromMember(b,a)}}))};f.prototype.seriesFromMeasure=function(a,d){var e=this;return _.map(this.pivot.xAxisDimension.members,function(h){var j;j=c.fromDimensionMember(h);j=new b(d,j);j=a.concat([j]);return{x:h.key,y:(new p(e.row,j,d)).value}})};f.prototype.seriesFromMember=function(a,b){var d,e=this;d=c.fromDimensionMember(b);return _.map(this.pivot.xAxisDimension.members,function(b){var h;
h=c.fromDimensionMember(b);h=a.concat([d,h]);return{x:b.key,y:(new p(e.row,h)).value}})};h.ChartCell=e=f;h=this.Wonkavision.PivotTable;f=function(b,c,d){this.name=b;this.dimensions=c;this.pivotTable=d;this.members=new a};f.prototype.initialize=function(){if(!(this.isEmpty=1>this.dimensions.length))return this.startIndex=this.dimensions[0].keyIndex,this.endIndex=this.startIndex+this.dimensions.length-1,this.initLevels()};f.prototype.initLevels=function(a,b){var d,e,h,j,f,g,p;null==a&&(a=[]);null==
b&&(b=this);e=a.length;if(e<this.dimensions.length){g=this.dimensions[e].members;p=[];j=0;for(f=g.length;j<f;j++)h=g[j],h.isEmpty=!0,d=a.slice(0),d.push(h.key),h=b.members.push(new c(d,b,e+this.startIndex,h)),p.push(this.initLevels(d,h));return p}};f.prototype.registerCell=function(a){var b;if(!a.empty&&!(this.isEmpty||a.key.length<=this.startIndex))if(b=a.key.slice(this.startIndex,+this.startIndex+1||9E9),b=this.members.get(b))return b.registerCell(a)};f.prototype.appendMeasures=function(){return this.members.appendMeasures(this.pivotTable.cellset)};
h.Axis=f;h=this.Wonkavision.PivotTable;f=function(b,c,d,e){var h;this.key=b;this.parent=c;this.keyIndex=d;this.member=e;this.axis=null!=(null!=(h=this.parent)?h.axis:void 0)?this.parent.axis:this.parent;this.caption=this.member.caption;this.depth=this.axis?this.keyIndex-this.axis.startIndex:0;this.isEmpty=!0;this.isLeaf=this.axis?this.keyIndex===this.axis.endIndex:0;this.isLeaf||(this.members=new a)};f.prototype.cellKey=function(){return this.key};f.prototype.leaves=function(a){null==a&&(a=!1);return this.isLeaf?
[this]:this.members.leaves(a)};f.prototype.registerCell=function(a){var b;this.isEmpty=!1;this.member.isEmpty=!1;if(!this.isLeaf&&(b=this.keyIndex+1,b=a.key.slice(this.axis.startIndex,+b+1||9E9),b=this.members.get(b)))return b.registerCell(a)};h.Member=c=f;this.Wonkavision.PivotTable.Member.fromDimensionMember=function(a){return new c([a.key],null,a.dimension.keyIndex,a)};h=this.Wonkavision.PivotTable;f=function(a,b){this.measureName=a;this.key=b.key.concat(["@"+a]);this.parent=b;this.axis=b.axis;
this.caption=a;this.depth=b.depth+1;this.isEmpty=b.isEmpty;this.isLeaf=!0;b.isLeaf=!1;this.isMeasure=!0;this.keyIndex=b.keyIndex};k(f,c);f.prototype.cellKey=function(){return this.key.slice(0,-1)};h.MeasureMember=b=f;var k=this.Wonkavision.PivotTable,n=function(a,b){var c=this;null==a&&(a=[]);this.isNonEmpty=null!=b?b:!1;this.members=[];this.length=0;_.each(a,function(a){return c.push(a)})};n.prototype.get=function(a){return _.find(this.members,function(b){return b.key.toString()===a.toString()})};
n.prototype.push=function(a){this.invalidateCache();this.length+=1;this.members.push(a);return a};n.prototype.each=function(a){return _.each(this.members,a)};n.prototype.map=function(a){return _.each(this.members,a)};n.prototype.nonEmpty=function(){return new n(_.filter(this.members,function(a){return!a.isEmpty}),!0)};n.prototype.leaves=function(a){var b;null==a&&(a=this.isNonEmpty);null==this.leafCache&&(b=a?this.nonEmpty().members:this.members,this.leafCache=_.flatten(_.map(b,function(b){return b.leaves(a)})));
return this.leafCache};n.prototype.at=function(a){return this.members[a]};n.prototype.toArray=function(){return this.members};n.prototype.flatten=function(a,b){null==b&&(b=[]);null==a&&(a=this.isNonEmpty);this.map(function(c){if(!a||!c.isEmpty)if(b.push(c),!c.isLeaf)return c.members.flatten(a,b)});return b};n.prototype.partitionH=function(a){null==a&&(a=this.isNonEmpty);a=this.flatten(a);return _.reduce(a,function(a,b){var c,d;c=_.last(a);(d=_.last(c))&&d.depth>=b.depth?a.push([b]):c.push(b);return a},
[[]])};n.prototype.partitionV=function(a){null==a&&(a=this.isNonEmpty);a=this.flatten(a);return _.reduce(a,function(a,b){var c;(a[c=b.depth]||(a[c]=[])).push(b);return a},[])};n.prototype.appendMeasures=function(a){var c;c=a.measureNames;a=this.leaves();_.each(a,function(a){return a.members=new n(_.map(c,function(c){return new b(c,a)}))});return this.invalidateCache(!0)};n.prototype.invalidateCache=function(a){null==a&&(a=!1);this.leafCache=null;if(a)return this.each(function(a){if(null!=a.members)return a.members.invalidateCache()})};
k.MemberCollection=a=n}).call(this);(function(){var e=this.Wonkavision,d=function(b,c){this.dimension=b;this.key=c.key;this.caption=c.caption||this.key;this.sort=c.sort||this.caption;this.attributes=c.attributes||{}};d.prototype.toString=function(){return key.toString()};d.prototype.toKey=function(){return key};e.Member=d}).call(this);
(function(){var e;e=this.Wonkavision.Member;this.Wonkavision.Dimension=function(d,b,c){var a=this;this.axis=d;this.keyIndex=c;this.name=b.name;this.members=_.sortBy(_.map(b.members,function(b){return new e(a,b)}),function(a){return a.sort})}}).call(this);
(function(){var e;e=this.Wonkavision.Dimension;this.Wonkavision.Axis=function(d,b,c,a){var h;this.name=d;this.cellset=b;this.startIndex=a;this.dimensions=[];this.dimensionNames=[];h=c.dimensions;b=c=0;for(a=h.length;c<a;b=++c)d=h[b],this.dimensions.push(new e(this,d,this.startIndex+b)),this.dimensionNames.push(d.name);this.endIndex=this.startIndex+this.dimensions.length-1}}).call(this);
(function(){var e=this.Wonkavision,d=function(b){var c;this.name=b.name;null!=b.value&&(this.value=parseFloat(b.value));this.formattedValue=b.formatted_value||(null!=(c=this.value)?c.toString():void 0);this.calculated=b.calculated||!1;this.empty=!this.value};d.prototype.toString=function(){return this.formatted_value};e.Measure=d}).call(this);
(function(){var e;e=this.Wonkavision.Measure;var d=this.Wonkavision,b=function(b,a){var d,e,j,l;this.cellset=b;this.measures={};this.empty=!0;if(a){l=a.measures;e=0;for(j=l.length;e<j;e++)d=l[e],this.addMeasure(d);this.key=a.key}};b.prototype.addMeasure=function(b){var a;a=b.name;this[a]=new e(b);this.measures[a]=this[a];if(!this[a].empty)return this.empty=!1};d.Cell=b}).call(this);
(function(){var e,d,b;d=this.Wonkavision.Cell;e=this.Wonkavision.Axis;b=this.Wonkavision.Filter;var c=this.Wonkavision,a=function(a,c){var j,l,k,g,f,m;null==a&&(a={});this.query=null!=c?c:null;this.cube=a.cube||null;g=a.slicer||[];l=a.filters||[];k=[];f=0;for(m=g.length;f<m;f++)j=g[f],k.push(b.parse(j));this.slicer=k;m=[];g=0;for(f=l.length;g<f;g++)j=l[g],m.push(b.parse(j));this.filters=m;this.totals=new d(this,a.totals);this.measureNames=a.measure_names||[];l=0;m=[];k=g=0;for(f=a.axes.length;0<=
f?g<f:g>f;k=0<=f?++g:--g)j=a.axes[k],k=Wonkavision.AXIS_NAMES[k],j=new e(k,this,j,l),l=j.endIndex+1,m.push(j);this.axes=m;this.cells={};f=a.cells||[];l=0;for(g=f.length;l<g;l++)j=f[l],this.cells[j.key]=new d(this,j);m=Wonkavision.AXIS_NAMES;l=g=0;for(f=m.length;g<f;l=++g)j=m[l],this[j]=this.axes[l]};a.prototype.cell=function(){var a,b;b=function(){var b,c,d;if("undefined"!==typeof a&&null!==a)return a.toString();d=[];b=0;for(c=arguments.length;b<c;b++)a=arguments[b],d.push(a);return d}.apply(this,
arguments);return this.cells[b]||new d(this)};c.Cellset=a}).call(this);
(function(){var e=this.Wonkavision,d=function(b){null==b&&(b={});b=_.defaults(b,{windowSize:30,calculation:"average",injectMissingDates:!0});this.windowSize=b.windowSize;this.calculation=b.calculation;this.injectMissingDates=b.injectMissingDates;this.reset()};d.prototype.add=function(b,c){b=moment(b);this.currentDate||(this.currentDate=b);this.advanceTo(b);this.addSample(c);return this};d.prototype.reset=function(){this.samples=[];this.values=[];this.currentDate=null;return this};d.prototype.advanceTo=
function(b){var c;b=moment(b);for(c=[];null!=this.currentDate&&this.currentDate<b;)c.push(this.skipDay());return c};d.prototype.skipDay=function(){return this.injectMissingDates?this.addSample(0):this.advanceDay()};d.prototype.advanceDay=function(){return this.currentDate.add("days",1)};d.prototype.addSample=function(b){this.samples.unshift(b);this.samples.length>this.windowSize&&this.samples.pop();this.values.push([1E3*this.currentDate.clone().unix(),this.currentValue()]);return this.advanceDay()};
d.prototype.currentValue=function(){var b;b=_.reduce(this.samples,function(b,a){return b+a},0);return"average"===this.calculation?b/this.samples.length:b};e.MovingCalculation=d}).call(this);
(function(){var e,d=function(b,c){this.view=b;this.extractArgs(c);this.palette=new Rickshaw.Color.Palette({scheme:this.colorScheme})};d.prototype.renderGraph=function(b,c){var a,d,e,j=this;d=_.map(b,function(a){return{name:a.name,color:j.colorFor(a.name),data:a.data}});a=c.append("div").attr("class","wv-chart");e=c.append("div").attr("class","wv-y-axis");a=new Rickshaw.Graph(_.extend(this.graphArgs,{element:a[0][0],series:d}));new Rickshaw.Graph.Axis.Time(_.extend(this.xAxisArgs,{graph:a}));new Rickshaw.Graph.Axis.Y(_.extend(this.yAxisArgs,
{graph:a,element:e[0][0]}));new Rickshaw.Graph.HoverDetail(_.extend(this.hoverArgs,{graph:a}));return a.render()};d.prototype.colorFor=function(b){var c;this.colorCache||(this.colorCache={});return(c=this.colorCache)[b]||(c[b]=this.palette.color())};d.prototype.extractArgs=function(b){this.colorScheme=b.palette||b.colorScheme||this.colorScheme||"munin";this.graphArgs=_.defaults(b.graph||{},{width:300,height:300,renderer:"line"});this.xAxisArgs=b.xAxis||{};this.yAxisArgs=_.defaults(b.yAxis||{},{orientation:"left",
tickFormat:Rickshaw.Fixtures.Number.formatKMBT});return this.hoverArgs=b.hover||{}};(e=this.Wonkavision).renderers||(e.renderers={});this.Wonkavision.renderers.Rickshaw=d}).call(this);
(function(){var e,d=function(b,c){this.view=b;this.extractArgs(c)};d.prototype.renderGraph=function(b,c){var a;a=c.append("div").attr("class","wv-chart");a=_.extend(this.chartArgs,{series:b,chart:_.extend(this.chartArgs.chart,{renderTo:a[0][0]})});return new Highcharts.Chart(a)};d.prototype.extractArgs=function(b){var c,a,d,e,j,l,k,g,f,m,n,q,r,s,t;this.chartArgs=b.highchart||{};this.chartArgs.chart=_.defaults(this.chartArgs.chart||{},{borderColor:"#CCC",type:"line",backgroundColor:"white",spacingBottom:10,
spacingTop:10});this.chartArgs.tooltip=_.defaults(this.chartArgs.tooltip||{},{shared:!0});this.chartArgs.plotOptions=_.extend(this.chartArgs.plotOptions||{},{series:_.defaults((null!=(c=this.chartArgs.plotOptions)?c.series:void 0)||{},{animation:!1}),line:_.defaults((null!=(a=this.chartArgs.plotOptions)?a.line:void 0)||{},{marker:_.defaults((null!=(g=this.chartArgs.plotOptions)?null!=(f=g.line)?f.marker:void 0:void 0)||{},{enabled:!1}),shadow:!1}),column:_.defaults((null!=(m=this.chartArgs.plotOptions)?
m.column:void 0)||{},{shadow:!1}),bar:_.defaults((null!=(n=this.chartArgs.plotOptions)?n.bar:void 0)||{},{shadow:!1}),spline:_.defaults((null!=(q=this.chartArgs.plotOptions)?q.spline:void 0)||{},{marker:_.defaults((null!=(r=this.chartArgs.plotOptions)?null!=(s=r.spline)?s.marker:void 0:void 0)||{},{enabled:!1}),shadow:!1}),area:_.defaults((null!=(t=this.chartArgs.plotOptions)?t.area:void 0)||{},{marker:_.defaults((null!=(d=this.chartArgs.plotOptions)?null!=(e=d.area)?e.marker:void 0:void 0)||{},{enabled:!1}),
shadow:!1}),areaspline:_.defaults((null!=(j=this.chartArgs.plotOptions)?j.areaspline:void 0)||{},{marker:_.defaults((null!=(l=this.chartArgs.plotOptions)?null!=(k=l.areaspline)?k.marker:void 0:void 0)||{},{enabled:!1}),shadow:!1})});return this.chartArgs.xAxis=_.defaults(this.chartArgs.xAxis||{},{type:"datetime"})};d.prototype.keyToDate=function(b){b=""+b.slice(0,4)+"-"+b.slice(4,6)+"-"+b.slice(6,8);return 1E3*moment(b).unix()};(e=this.Wonkavision).renderers||(e.renderers={});this.Wonkavision.renderers.Highcharts=
d}).call(this);
(function(){var e,d;e=this.Wonkavision.MovingCalculation;d=this.Wonkavision.Utilities;var b=this.Wonkavision,c=function(a){_.bindAll(this,"render","renderTable","renderColumnHeaders","renderTableData");this.extractArgs(a)};c.prototype.render=function(a){this.extractArgs(a);this.pivot="text"===this.viewType?new Wonkavision.PivotTable(this.data,a):new Wonkavision.ChartTable(this.data,a);this.pivot.isFlat&&"text"===this.viewType&&this.pivot.pivot();this.dataTable=this.pivot.createDataTable();null==this.suppressMeasureHeaders&&
(this.suppressMeasureHeaders=2>this.pivot.cellset.measureNames.length);return this.element.append("table").attr("class","wv-pivot-table").call(this.renderTable)};c.prototype.extractArgs=function(a){a.data&&(this.data=a.data);a.element&&(this.element=d3.selectAll(a.element));this.viewType=a.viewType||a.view||this.detectViewType(a);this.renderer="text"===this.viewType?a.cellRenderer:this.createRenderer(a);this.formatLabel=a.formatLabel||function(a){return a};this.formatData=a.formatData||function(a){return null!=
a.formattedValue?a.formattedValue:"-"};if(this.smooth=a.smooth)this.smoothingMethod=a.smoothingMethod,this.smoothingWindow=a.smoothingWindow||30;return this.suppressMeasureHeaders=a.suppressMeasureHeaders};c.prototype.createRenderer=function(a){return new (a.renderer||Wonkavision.renderers["default"]||Wonkavision.renderers.Rickshaw)(this,a)};c.prototype.memberSpan=function(a){var b;return null!=(b=a.members)?b.nonEmpty().leaves().length:void 0};c.prototype.renderTable=function(a){this.dataRows=[];
this.table=a;this.table.call(this.renderColumnHeaders);return this.table.call(this.renderTableData)};c.prototype.renderColumnHeaders=function(a){var b,c=this;if(this.pivot.isFlat&&"rows"===this.pivot.measuresAxis)return b=_.map(this.pivot.axes[0].dimensions,function(a){return a.name}),b=b.concat(this.pivot.cellset.measureNames),a=a.append("thead"),a=a.append("tr").attr("class","wv-col"),a.selectAll("th.wv-col-header").data(b).enter().append("th").text(function(a){return c.formatLabel(a)});b=this.dataTable.columnMembers;
a=a.append("thead");b=a.selectAll("tr.wv-col").data(this.filterColHeaders(b)).enter().append("tr").attr("class","wv-col");a=this.pivot.rows.dimensions.length+("rows"===this.pivot.measuresAxis&&!this.suppressMeasureHeaders?1:0);b.append("th").attr("colspan",a);return b.selectAll("td.wv-col-header").data(function(a){return a},function(a){return a.key.toString()}).enter().append("th").text(function(a){return c.formatLabel(a.caption)}).attr("colspan",function(a){return c.memberSpan(a)}).attr("class",
"wv-col-header")};c.prototype.renderTableData=function(a){var b,c=this;a=a.append("tbody").selectAll("tr.wv-row").data(this.dataTable.rows).enter().append("tr").attr("class","wv-row");a.selectAll("th.wv-row-header").data(function(a){return c.filterRowHeaders(a.rowMembers)},function(a){return a.key.toString()}).enter().append("th").text(function(a){return c.formatLabel(a.caption)}).attr("rowspan",function(a){return c.memberSpan(a)}).attr("class","wv-row-header");b=this;a=a.selectAll("td.wv-cell").data(function(a){return a.cells}).enter().append("td").attr("class",
"wv-cell");return"text"===this.viewType?a.each(function(a,c){return b.renderCell(a,c,this)}):a.each(function(a,c){return b.renderGraph(a,c,this)})};c.prototype.filterRowHeaders=function(a){if(!(0<a.length))return a;null!=_.last(a).isMeasure&&this.suppressMeasureHeaders&&(a=a.slice(0,-1));return a};c.prototype.filterColHeaders=function(a){return this.suppressMeasureHeaders&&"columns"===this.pivot.measuresAxis?a.slice(0,-1):a};c.prototype.renderCell=function(a,b,c){var d=this;this.renderer||(this.renderer=
function(a,b,c){return d3.select(c).text(function(a){return d.formatData(a)})});return this.renderer(a,b,c)};c.prototype.renderGraph=function(a,b,c){a=this.prepareSeries(a.series);c=d3.select(c).append("div").attr("class","wv-chart-container");return this.renderer.renderGraph(a,c)};c.prototype.detectViewType=function(a){return null!=a.seriesSource||null!=a.seriesFrom?"chart":"text"};c.prototype.prepareSeries=function(a){var b=this;return a=_.map(a,function(a){return{name:b.formatLabel(a.name),data:b.prepareSeriesData(a.data)}})};
c.prototype.prepareSeriesData=function(a){var b,c=this;return null!=this.smoothingMethod?(b=new e({windowSize:this.smoothingWindow,calculation:this.smoothingMethod}),_.each(a,function(a){return b.add(c.keyToDate(a.x),parseFloat(a.y||0))}),_.map(b.values.slice(this.smoothingWindow),function(a){return{x:a[0],y:a[1]}})):_.map(a,function(a){return{x:c.keyToDate(a.x),y:parseFloat(a.y)||0}})};c.prototype.keyToDate=function(a){return 1E3*d.keyToDate(a,!1).unix()};b.PivotTableView=c}).call(this);
