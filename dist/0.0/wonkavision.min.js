/*  wonkavision.js, version 0.0.1

Copyright (c) 2011 [your name here]

Permission is hereby granted, free of charge, to any person
obtaining a copy of this software and associated documentation
files (the "Software"), to deal in the Software without
restriction, including without limitation the rights to use,
copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the
Software is furnished to do so, subject to the following
conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
OTHER DEALINGS IN THE SOFTWARE.
------------------------------------------------------------------*/
(function(){var j=function(){},c=function(a){null==a&&(a={});this.url=a.url||"";this.facts={};this.aggregations={}};c.prototype.query=function(a){null==a&&(a={});return new j.Query(this,a)};c.prototype.dimensionQuery=function(a){null==a&&(a={});return new j.DimensionQuery(this,a)};c.prototype.executeDimension=function(a,b){var c;c=b.error||function(){};this.get("dimension_query",a.toParams(),function(a){var l;null!=a.json.error?optons.error(a.json.error):l=a.json;return b.success(l)},c);return this};
c.prototype.execute=function(a,b){var c,f;f=b.raw;c=b.error||function(){};this.get(b.facts?"facts":"query",a.toParams(),function(l){if(null!=l.json.error)return b.error(l.json.error);l=f?l:b.facts?l.json.data:new j.Cellset(l.json,a);return b.success(l)},c);return this};c.prototype.get=function(a,b,c,f){var l;l=this.url+("/"===this.url.substr(-1)?"":"/");return j.Remote.get(l+a,{data:b,success:c,error:f})};j.Client=c;this.Wonkavision=j;this.Wonkavision.AXIS_NAMES=["columns","rows","pages","chapters",
"sections"]}).call(this);
(function(){var j;j=this.Wonkavision;j.Utilities={keyToDate:function(c,a){var b;null==a&&(a=!0);c=c.toString().replace("-","");b=""+c.slice(0,4)+"-"+(c.slice(4,6)||"01")+"-"+(c.slice(6,8)||"01");b=moment(b);return a?b._d:b},dateToKey:function(c){null==c&&(c=moment());return parseInt(moment(c).format("YYYYMMDD"))},rangeToKeys:function(c){return _.map(c,this.dateToKey)},beginningOfMonth:function(c){null==c&&(c=new Date);return moment(c).startOf("month")._d},endOfMonth:function(c){null==c&&(c=new Date);
return moment(c).endOf("month")._d},quarter:function(c){null==c&&(c=new Date);return parseInt(moment(c).month()/3)+1},beginningOfQuarter:function(c){var a;null==c&&(c=new Date);c=moment(c);a=c.month()%3;return c.add("months",-1*a).date(1)._d},beginningOfYear:function(c){null==c&&(c=new Date);return moment(c).dayOfYear(1)._d},dateRange:function(c,a,b){null==b&&(b=!1);c=[c,a];return b?this.rangeToKeys(c):c},timeWindow:function(c,a,b,d){null==d&&(d=!1);a=moment(c).add(a,-1*b)._d;c=moment(c);return this.dateRange(a,
c,d)},mtd:function(c,a){var b;null==c&&(c=new Date);null==a&&(a=!1);b=this.beginningOfMonth(c);return this.dateRange(b,c,a)},ytd:function(c,a){var b;null==c&&(c=new Date);null==a&&(a=!1);b=this.beginningOfYear(c);return this.dateRange(b,c,a)},qtd:function(c,a){var b;null==c&&(c=new Date);null==a&&(a=!1);b=this.beginningOfQuarter(c);return this.dateRange(b,c,a)},lastMonth:function(c,a){var b;null==a&&(a=!1);b=moment(b).add("months",-1);return this.dateRange(this.beginningOfMonth(b),this.endOfMonth(b),
a)},smoothSeries:function(c,a){var b;null==a&&(a={});_.defaults(a,{windowSize:30,windowType:"days",calculation:"average",transformation:function(b){return b}});b=new j.MovingCalculation(a);_.each(c,function(a){return b.add(a.x,a.y)});return _.map(b.values.slice(a.windowSize),function(b){return{x:b[0],y:b[1]}})},sortRows:function(c,a){var b,d,f;null==a&&(a={});f=a.measureName||c.measureNames[0];b=a.columnKey||null;d=a.direction||1;return c.rows.dimensions[0].sortBy(function(a){var m,k;return((null!=
(m=c.cell(b,a.key))?null!=(k=m.measures[f])?k.value:void 0:void 0)||0)*d})}}}).call(this);
(function(){var j=this.Wonkavision,c=function(){};c.prototype.xhr=function(a){a=this.createSettings(a.url,a);a.ajax=a.xhr();if(a.ajax)return this.prepareUrl(a),a.ajax.open(a.type,a.url,a.async),a.ajax.setRequestHeader("Accept","application/json"),a.ajax.send(a.data||null),this.httpData(a)};c.prototype.prepareUrl=function(a){if("GET"===a.type&&a.data)return a.url+=/\?/.test(a.url)?"&":"?",a.url+=this.toParams(a.data),a.data=null};c.prototype.createSettings=function(a,b){null==b&&(b={});return{url:a,
data:b.data||"",success:b.success||function(){},error:b.error||function(){},type:b.type||"GET",async:b.async||!0,xhr:function(){return new window.XMLHttpRequest}}};c.prototype.toParams=function(a){var b,c,f;null==a&&(a={});c=[];for(b in a)f=a[b],c.push(""+b+"="+f);return encodeURI(c.join("&"))};c.prototype.httpData=function(a){return a.ajax.onreadystatechange=function(){var b;if(4===a.ajax.readyState){try{b=JSON.parse(a.ajax.responseText)}catch(c){console.log("Could not parse response ("+a.ajax.responseText+
") as JSON:"+c)}b={xml:a.ajax.responseXML,text:a.ajax.responseText,json:b};/(2..)/.test(a.ajax.status)?a.success.call(a.ajax,b):(console.log("There was an error processing a Wonkavision data request:"+a.ajax.statusText),a.error&&a.error.call(null,a.ajax.statusText));return b}return null}};j.Remote=c;this.Wonkavision.Remote.ajax=function(a){return(new c).xhr(a)};this.Wonkavision.Remote.get=function(a,b){b.url=a;return(new c).xhr(b)};this.Wonkavision.Remote.post=function(a,b){b.url=a;b.type="POST";
return(new c).xhr(b)}}).call(this);
(function(){var j=this.Wonkavision,c=function(a,b){this.name=a;null==b&&(b={});var c=this.isFact,f=this;this.isFact=function(){return c.apply(f,arguments)};this.operator=b.operator||"eq";this.memberType=b.memberType||"dimension";this.value=b.value;this.attributeName=b.attributeName||(this.isDimension?"key":"count");this.operators="eq ne gt gte lt lte in nin".split(" ")};c.prototype.isDimension=function(){return"dimension"===this.memberType};c.prototype.isMeasure=function(){return"measure"===this.memberType};
c.prototype.isFact=function(){return"fact"===this.memberType};c.prototype.toString=function(){null===this.value&&(this.value="");return[this.memberType,this.name,this.attributeName,this.operator,this.value.toString()].join("::")};c.prototype.parse=function(a,b){var c;null==b&&(b="::");c=a.split(b);if("dimension"===c[0]||"measure"===c[0]||"fact"===c[0])this.memberType=c.shift();this.name=c.shift();this.attributeName=c.shift()||this.attributeName;this.operator=c.shift()||this.operator;this.value=c.shift()||
this.value;return this};c.prototype.withValue=function(a){this.value=a;return this};j.Filter=c;this.Wonkavision.Filter.parse=function(a,b){null==b&&(b="::");return(new c("")).parse(a,b)}}).call(this);
(function(){var j=this.Wonkavision,c=function(a,b){this.name=a;null==b&&(b={});this.memberType=b.memberType||"dimension";this.value=b.value;this.attributeName=b.attributeName||(this.isDimension?"key":"count");this.order="asc"};c.prototype.isDimension=function(){return"dimension"===this.memberType};c.prototype.isMeasure=function(){return"measure"===this.memberType};c.prototype.isFact=function(){return"fact"===this.membertype};c.prototype.toString=function(){return[this.memberType,this.name,this.attributeName,
this.order].join("::")};c.prototype.parse=function(a,b){var c;null==b&&(b="::");c=a.split(b);if("dimension"===c[0]||"measure"===c[0]||"fact"===c[0])this.memberType=c.shift();this.name=c.shift();this.attributeName=c.shift()||this.attributeName;this.order=c.shift()||this.order;return this};j.MemberReference=c;this.Wonkavision.MemberReference.parse=function(a,b){null==b&&(b="::");return(new c("")).parse(a,b)}}).call(this);
(function(){var j,c,a=[].slice;j=this.Wonkavision.Filter;c=this.Wonkavision.MemberReference;var b=this.Wonkavision,d=function(b,a){var c,k,d,g;this.client=b;null==a&&(a={});g=Wonkavision.AXIS_NAMES;k=0;for(d=g.length;k<d;k++)c=g[k],this[c]=this.select(c);this.listDelimiter=a.listDelimiter||"|";this.axes=[];this.selectedMeasures=[];this.order_by_attributes=[];this.selected_attributes=[];this.topFilter=null;g=Wonkavision.AXIS_NAMES;k=0;for(d=g.length;k<d;k++)if(c=g[k],null!=a[c])this[c](a[c]);this.filters=
a.filters||[];null!=a.measures&&this.measures(a.measures);null!=a.where&&this.where(a.where);null!=a.from&&this.from(a.from);null!=a.order&&this.order(a.order);null!=a.attributes&&this.attributes(a.attributes);null!=a.top&&this.top(a.top);this.includeTotals=!!a.includeTotals;this.originalQuery=a};d.prototype.cube=function(a){this.cubeName=a;return this};d.prototype.from=function(a){this.cubeName=a;return this};d.prototype.measures=function(){var b;b=1<=arguments.length?a.call(arguments,0):[];this.selectedMeasures=
this.selectedMeasures.concat(_.flatten(b));return this};d.prototype.where=function(a){var b,c;null==a&&(a={});this.filters=this.filters.concat(function(){var d;d=[];for(b in a)c=a[b],d.push(j.parse(b,".").withValue(c));return d}());return this};d.prototype.order=function(){var b,l;l=1<=arguments.length?a.call(arguments,0):[];this.order_by_attributes=this.order_by_attributes.concat(function(){var a,d,h,g;h=_.flatten(l);g=[];a=0;for(d=h.length;a<d;a++)b=h[a],g.push(c.parse(b,"."));return g}());return this};
d.prototype.attributes=function(){var b,l;l=1<=arguments.length?a.call(arguments,0):[];this.selected_attributes=this.selected_attributes.concat(function(){var a,d,h,g;h=_.flatten(l);g=[];a=0;for(d=h.length;a<d;a++)b=h[a],g.push(c.parse(b,"."));return g}());return this};d.prototype.top=function(a){var b;this.topFilter={};this.topFilter.count=a.count;this.topFilter.dimension=a.dimension;this.topFilter.measure=a.measure;this.topFilter.exclude=_.compact(_.flatten([a.exclude]));if(a.where){var c=this.topFilter,
d,h;d=a.where;h=[];for(b in d)a=d[b],h.push(j.parse(b,".").withValue(a));return c.filters=h}};d.prototype.toParams=function(){var a,b,c,d,h;b={from:this.cubeName};1>this.selectedMeasures.length||(b.measures=this.selectedMeasures.join(this.listDelimiter));if(!(1>this.filters.length)){c=this.listDelimiter;var g,e;g=this.filters;e=[];d=0;for(h=g.length;d<h;d++)a=g[d],e.push(a.toString());b.filters=e.join(c)}if(!(1>this.order_by_attributes.length)){c=this.listDelimiter;g=this.order_by_attributes;e=[];
d=0;for(h=g.length;d<h;d++)a=g[d],e.push(a.toString());b.order=e.join(c)}if(!(1>this.selected_attributes.length)){c=this.listDelimiter;g=this.selected_attributes;e=[];d=0;for(h=g.length;d<h;d++)a=g[d],e.push(a.toString());b.attributes=e.join(c)}h=Wonkavision.AXIS_NAMES;c=0;for(d=h.length;c<d;c++)a=h[c],this.getAxis(a)&&(b[a]=this.getAxis(a).join(this.listDelimiter));if(null!=this.topFilter&&(b.top_filter_count=this.topFilter.count,b.top_filter_dimension=this.topFilter.dimension,null!=this.topFilter.measure&&
(b.top_filter_measure=this.topFilter.measure),null!=this.topFilter.exclude&&(b.top_filter_exclude=this.topFilter.exclude.join(this.listDelimiter)),this.topFilter.filters)){c=this.listDelimiter;g=this.topFilter.filters;e=[];d=0;for(h=g.length;d<h;d++)a=g[d],e.push(a.toString());b.top_filter_filters=e.join(c)}b.from=this.cubeName;return b};d.prototype.toString=function(){return toHash().toString()};d.prototype.execute=function(a){null==a&&(a={});return this.client.execute(this,a)};d.prototype.getAxis=
function(a){return this.axes[Wonkavision.AXIS_NAMES.indexOf(a)]};d.prototype.select=function(b){var c=this;return function(){var d,k;d=1<=arguments.length?a.call(arguments,0):[];k=Wonkavision.AXIS_NAMES.indexOf(b);0<=k&&(c.axes.length>k&&(d=c.axes[k].concat(d)),c.axes[k]=_.flatten(d));return c}};b.Query=d}).call(this);
(function(){var j,c,a=[].slice;j=this.Wonkavision.Filter;c=this.Wonkavision.MemberReference;var b=this.Wonkavision,d=function(a,b){this.client=a;null==b&&(b={});this.listDelimiter=b.listDelimiter||"|";this.order_by_attributes=[];this.selected_attributes=[];this.filters=b.filters||[];null!=b.where&&this.where(b.where);null!=b.from&&this.from(b.from);null!=b.order&&this.order(b.order);null!=b.attributes&&this.attributes(b.attributes);this.originalQuery=b};d.prototype.dimension=function(a){this.dimensionName=
a;return this};d.prototype.from=function(a){this.dimensionName=a;return this};d.prototype.where=function(a){var b,c;null==a&&(a={});this.filters=this.filters.concat(function(){var d;d=[];for(b in a)c=a[b],d.push(j.parse(b,".").withValue(c));return d}());return this};d.prototype.order=function(){var b,d;d=1<=arguments.length?a.call(arguments,0):[];this.order_by_attributes=this.order_by_attributes.concat(function(){var a,k,h,g;h=_.flatten(d);g=[];a=0;for(k=h.length;a<k;a++)b=h[a],g.push(c.parse(b,"."));
return g}());return this};d.prototype.attributes=function(){var b,d;d=1<=arguments.length?a.call(arguments,0):[];this.selected_attributes=this.selected_attributes.concat(function(){var a,k,h,g;h=_.flatten(d);g=[];a=0;for(k=h.length;a<k;a++)b=h[a],g.push(c.parse(b,"."));return g}());return this};d.prototype.toParams=function(){var a,b;b={from:this.dimensionName};if(!(1>this.filters.length)){var c=this.listDelimiter,d,h,g,e;g=this.filters;e=[];d=0;for(h=g.length;d<h;d++)a=g[d],e.push(a.toString());
b.filters=e.join(c)}if(!(1>this.order_by_attributes.length)){c=this.listDelimiter;g=this.order_by_attributes;e=[];d=0;for(h=g.length;d<h;d++)a=g[d],e.push(a.toString());b.order=e.join(c)}if(!(1>this.selected_attributes.length)){c=this.listDelimiter;g=this.selected_attributes;e=[];d=0;for(h=g.length;d<h;d++)a=g[d],e.push(a.toString());b.attributes=e.join(c)}b.from=this.dimensionName;return b};d.prototype.toString=function(){return toHash().toString()};d.prototype.execute=function(a){null==a&&(a={});
return this.client.executeDimension(this,a)};b.DimensionQuery=d}).call(this);
(function(){var j,c,a,b,d,f,l,m,k={}.hasOwnProperty,h=function(a,b){function c(){this.constructor=a}for(var d in b)k.call(b,d)&&(a[d]=b[d]);c.prototype=b.prototype;a.prototype=new c;a.__super__=b.prototype;return a};f=this.Wonkavision;var g=function(a,b){var c,d,f,l,e,h,k,j,m,n=this;this.cellset=a;null==b&&(b={});this.axes=_.map(this.cellset.axes,function(a){return n[a.name]=new g.Axis(a.name,a.dimensions.slice(0),n)});(this.measuresAxis=b.measuresAxis||b.measuresOn)||(this.measuresAxis=this.isFlat?
"rows":"columns");this.initializeAxes();this.seriesCells={};this.isFlat=2>this.axes.length?!0:!1;k=this.cellset.cells;for(f in k){d=k[f];j=this.axes;e=0;for(h=j.length;e<h;e++)c=j[e],c.registerCell(d);null!=this.seriesDimension&&(c=d.key[this.seriesDimension.keyIndex],c=(l=this.seriesCells)[c]||(l[c]=[]),c.push(d))}null!=this.measuresAxis&&null!=(m=this[this.measuresAxis])&&m.appendMeasures()};g.prototype.initializeAxes=function(){var a,b,c,d,f;d=this.axes;f=[];b=0;for(c=d.length;b<c;b++)a=d[b],f.push(a.initialize());
return f};g.prototype.pivot=function(){var a;a=this.rows;this.rows=this.columns;return this.columns=a};g.prototype.createDataTable=function(){return new c(this)};g.prototype.createCell=function(a,b,c){null==c&&(c=null);return new l(a,b,c)};f.PivotTable=f=g;var e=this.Wonkavision,p=function(a,b){null==b&&(b={});this.seriesSource=b.seriesSource||b.seriesFrom||(1<a.measureNames.length?"measures":"rows");p.__super__.constructor.call(this,a,b)};h(p,f);p.prototype.initializeAxes=function(){this.xAxisDimension=
this.columns.dimensions.pop();this.seriesDimension="measures"!==this.seriesSource&&null!=this[this.seriesSource]?this[this.seriesSource].dimensions.pop():void 0;"measures"===this.seriesSource&&(this.measuresAxis=null);return p.__super__.initializeAxes.call(this)};p.prototype.createCell=function(a,b){return new j(a,b)};e.ChartTable=p;f=this.Wonkavision.PivotTable;e=function(a){var b,c,d=this;this.pivot=a;this.rowMembers=null!=(b=this.pivot.rows)?b.members.nonEmpty().partitionH():void 0;this.columnMembers=
null!=(c=this.pivot.columns)?c.members.nonEmpty().partitionV():void 0;this.rows=[];_.map(this.rowMembers,function(a){return d.addRow(a)})};e.prototype.addRow=function(a){return this.rows.push(this.createRow(a))};e.prototype.createRow=function(a){return new m(this,a)};f.DataTable=c=e;f=this.Wonkavision.PivotTable;e=function(a,b){var c=this;this.table=a;this.rowMembers=b;this.pivot=this.table.pivot;this.cells=[];this.rowMember=_.isArray(this.rowMembers)?_.last(this.rowMembers):this.rowMembers;this.totalsRow=
!!_.detect(this.rowMember,function(a){return null!=a?a.totals:void 0});this.pivot.isFlat&&"rows"===this.pivot.measuresAxis?_.map(this.pivot.cellset.measureNames,function(a){return c.addCell([c.rowMember],a)}):this.pivot.columns&&!this.pivot.columns.isEmpty?_.map(this.pivot.columns.members.nonEmpty().leaves(),function(a){return c.addCell([c.rowMember,a])}):this.addCell([this.rowMember])};e.prototype.addCell=function(a,b){return this.cells.push(this.pivot.createCell(this,a,b))};f.TableRow=m=e;f=this.Wonkavision.PivotTable;
e=function(a,b,c){var d,f,e;this.row=a;this.measureName=c;this.keyMembers=b.slice(0);this.pivot=this.row.pivot;this.cell=this.cellFor(this.keyMembers);this.measureName||(this.measureName=this.findMeasureName(this.keyMembers));this.measure=null!=(d=this.cell)?d[this.measureName]:void 0;this.value=null!=(f=this.measure)?f.value:void 0;this.formattedValue=null!=(e=this.measure)?e.formattedValue:void 0;this.totalsCell=!!_.detect(this.keyMembers,function(a){return null!=a?a.totals:void 0})};e.prototype.cellFor=
function(a){a=_.flatten(_.map(_.sortBy(_.compact(a),function(a){return a.keyIndex}),function(a){return a.cellKey()}));return this.pivot.cellset.cells[a]};e.prototype.findMeasureName=function(a){var b;return(null!=(b=_.find(a,function(a){return null!=(null!=a?a.measureName:void 0)}))?b.measureName:void 0)||this.pivot.cellset.measureNames[0]};f.TableCell=l=e;f=this.Wonkavision.PivotTable;e=function(a,b){var c,d=this;this.row=a;this.keyMembers=b;this.pivot=this.row.pivot;"measures"===this.pivot.seriesSource?
this.series=_.map(this.pivot.cellset.measureNames,function(a){return{name:a,data:d.seriesFromMeasure(b,a)}}):null!=this.pivot.seriesDimension&&(c=_.filter(this.pivot.seriesDimension.members,function(a){return null!=d.pivot.seriesCells[a.key]}),this.series=_.map(c,function(a){return{name:a.caption,data:d.seriesFromMember(b,a)}}))};e.prototype.seriesFromMeasure=function(c,d){var f,e=this;f=_.select(this.pivot.xAxisDimension.members,function(a){return null!=a.key});return _.map(f,function(f){var g;g=
b.fromDimensionMember(f);g=new a(d,g);g=c.concat([g]);return{x:f.key,y:(new l(e.row,g,d)).value}})};e.prototype.seriesFromMember=function(a,c){var d,f,e=this;f=b.fromDimensionMember(c);d=_.select(this.pivot.xAxisDimension.members,function(a){return null!=a.key});return _.map(d,function(c){var d;d=b.fromDimensionMember(c);d=a.concat([f,d]);return{x:c.key,y:(new l(e.row,d)).value}})};f.ChartCell=j=e;f=this.Wonkavision.PivotTable;e=function(a,b,c){this.name=a;this.dimensions=b;this.pivotTable=c;this.members=
new d};e.prototype.initialize=function(){if(!(this.isEmpty=1>this.dimensions.length))return this.startIndex=this.dimensions[0].keyIndex,this.endIndex=this.startIndex+this.dimensions.length-1,this.initLevels()};e.prototype.initLevels=function(a,c){var d,f,e,l,g,h,k;null==a&&(a=[]);null==c&&(c=this);f=a.length;if(f<this.dimensions.length){h=this.dimensions[f].members;k=[];l=0;for(g=h.length;l<g;l++)e=h[l],e.isEmpty=!0,d=a.slice(0),d.push(e.key),e=c.members.push(new b(d,c,f+this.startIndex,e)),k.push(this.initLevels(d,
e));return k}};e.prototype.registerCell=function(a){var b;if(!a.empty&&!(this.isEmpty||a.key.length<=this.startIndex))if(b=a.key.slice(this.startIndex,+this.startIndex+1||9E9),b=this.members.get(b))return b.registerCell(a)};e.prototype.appendMeasures=function(){return this.members.appendMeasures(this.pivotTable.cellset)};f.Axis=e;f=this.Wonkavision.PivotTable;e=function(a,b,c,f){var e;this.parent=b;this.keyIndex=c;this.member=f;this.key=a;this.axis=null!=(null!=(e=this.parent)?e.axis:void 0)?this.parent.axis:
this.parent;this.caption=this.member.caption;this.depth=this.axis?this.keyIndex-this.axis.startIndex:0;this.isEmpty=!0;this.isLeaf=this.axis?this.keyIndex===this.axis.endIndex:0;this.isLeaf||(this.members=new d);this.totals=this.member.totals};e.prototype.cellKey=function(){return this.key};e.prototype.leaves=function(a){null==a&&(a=!1);return this.isLeaf?[this]:this.members.leaves(a)};e.prototype.registerCell=function(a){var b;this.isEmpty=!1;this.member.isEmpty=!1;if(!this.isLeaf&&(b=this.keyIndex+
1,b=a.key.slice(this.axis.startIndex,+b+1||9E9),b=this.members.get(b)))return b.registerCell(a)};f.Member=b=e;this.Wonkavision.PivotTable.Member.fromDimensionMember=function(a){return new b([a.key],null,a.dimension.keyIndex,a)};f=this.Wonkavision.PivotTable;e=function(a,b){this.measureName=a;this.key=b.key.concat(["@"+a]);this.parent=b;this.axis=b.axis;this.caption=a;this.depth=b.depth+1;this.isEmpty=b.isEmpty;this.isLeaf=!0;b.isLeaf=!1;this.isMeasure=!0;this.keyIndex=b.keyIndex;this.member=b.member;
this.totals=this.member.totals};h(e,b);e.prototype.cellKey=function(){return this.key.slice(0,-1)};f.MeasureMember=a=e;var h=this.Wonkavision.PivotTable,n=function(a,b){var c=this;null==a&&(a=[]);this.isNonEmpty=null!=b?b:!1;this.members=[];this.length=0;_.each(a,function(a){return c.push(a)})};n.prototype.get=function(a){var b=this;return _.find(this.members,function(c){return b.compareKeys(c.key,a)})};n.prototype.compareKeys=function(a,b){return a.toString()===b.toString()};n.prototype.push=function(a){this.invalidateCache();
this.length+=1;this.members.push(a);return a};n.prototype.each=function(a){return _.each(this.members,a)};n.prototype.map=function(a){return _.each(this.members,a)};n.prototype.nonEmpty=function(){return new n(_.filter(this.members,function(a){return!a.isEmpty}),!0)};n.prototype.leaves=function(a){var b;null==a&&(a=this.isNonEmpty);null==this.leafCache&&(b=a?this.nonEmpty().members:this.members,this.leafCache=_.flatten(_.map(b,function(b){return b.leaves(a)})));return this.leafCache};n.prototype.at=
function(a){return this.members[a]};n.prototype.toArray=function(){return this.members};n.prototype.flatten=function(a,b){null==b&&(b=[]);null==a&&(a=this.isNonEmpty);this.map(function(c){if(!a||!c.isEmpty)if(b.push(c),!c.isLeaf)return c.members.flatten(a,b)});return b};n.prototype.partitionH=function(a){null==a&&(a=this.isNonEmpty);a=this.flatten(a);return _.reduce(a,function(a,b){var c,d;c=_.last(a);(d=_.last(c))&&d.depth>=b.depth?a.push([b]):c.push(b);return a},[[]])};n.prototype.partitionV=function(a){null==
a&&(a=this.isNonEmpty);a=this.flatten(a);return _.reduce(a,function(a,b){var c;(a[c=b.depth]||(a[c]=[])).push(b);return a},[])};n.prototype.appendMeasures=function(b){var c;c=b.measureNames;b=this.leaves();_.each(b,function(b){return b.members=new n(_.map(c,function(c){return new a(c,b)}))});return this.invalidateCache(!0)};n.prototype.invalidateCache=function(a){null==a&&(a=!1);this.leafCache=null;if(a)return this.each(function(a){if(null!=a.members)return a.members.invalidateCache()})};h.MemberCollection=
d=n}).call(this);(function(){var j=this.Wonkavision,c=function(a,b){this.dimension=a;this.key=b.key;this.caption=b.caption||this.key;this.sort=b.sort||this.caption;this.attributes=b.attributes||{};this.totals=!!b.totals};c.prototype.toString=function(){return("undefined"!==typeof key&&null!==key?key.toString():void 0)||"<null>"};c.prototype.toKey=function(){return key};j.Member=c}).call(this);
(function(){var j;j=this.Wonkavision.Member;var c=this.Wonkavision,a=function(a,c,f){var l=this;this.axis=a;this.keyIndex=f;this.name=c.name;this.members=_.sortBy(_.map(c.members,function(a){return new j(l,a)}),function(a){return a.sort});this.axis.cellset.includeTotals&&this.members.push(this.createTotalMember())};a.prototype.rawMembers=function(){return this.axis.cellset.includeTotals?this.members.slice(0,this.members.length-1):this.members};a.prototype.sortBy=function(a,c){null==c&&(c=!0);if(c){if(this.members=
this.rawMembers(),this.members=_.sortBy(this.members,a),this.axis.cellset.includeTotals)return this.members.push(this.createTotalMember())}else return this.members=_.sortBy(this.members,a)};a.prototype.createTotalMember=function(){return new j(this,{key:null,caption:""+this.name+"_total",totals:!0})};c.Dimension=a}).call(this);
(function(){var j;j=this.Wonkavision.Dimension;this.Wonkavision.Axis=function(c,a,b,d){var f;this.name=c;this.cellset=a;this.startIndex=d;this.dimensions=[];this.dimensionNames=[];f=b.dimensions;a=b=0;for(d=f.length;b<d;a=++b)c=f[a],this.dimensions.push(new j(this,c,this.startIndex+a)),this.dimensionNames.push(c.name);this.endIndex=this.startIndex+this.dimensions.length-1}}).call(this);
(function(){var j=this.Wonkavision,c=function(a){var b;this.name=a.name;null!=a.value&&(this.value=parseFloat(a.value));this.formattedValue=a.formatted_value||(null!=(b=this.value)?b.toString():void 0);this.calculated=a.calculated||!1;this.empty=!this.value};c.prototype.toString=function(){return this.formatted_value};j.Measure=c}).call(this);
(function(){var j,c;c=this.Wonkavision.Measure;j=this.Wonkavision.Filter;var a=this.Wonkavision,b=function(a,b){var c,m,k,h,g=this;this.cellset=a;this.measures={};this.dimensions=[];this.filters=[];this.empty=!0;if(b){h=b.measures;m=0;for(k=h.length;m<k;m++)c=h[m],this.addMeasure(c);for(this.key=b.key.slice(0);this.key.length<this.cellset.levelCount;)this.key.push(null);this.dimensions=b.dimensions||[];this.filters=_.map(this.dimensions,function(a,b){return new j(a,{value:_.compact(g.key)[b]})})}};
b.prototype.addMeasure=function(a){var b;b=a.name;this[b]=new c(a);this.measures[b]=this[b];if(!this[b].empty)return this.empty=!1};a.Cell=b}).call(this);
(function(){var j,c,a;c=this.Wonkavision.Cell;j=this.Wonkavision.Axis;a=this.Wonkavision.Filter;var b=this.Wonkavision,d=function(b,d){var m,k,h,g,e;null==b&&(b={});this.query=null!=d?d:null;this.cube=b.cube||null;this.includeTotals=!!(null!=(m=this.query)&&m.includeTotals);e=b.slicer||[];h=b.filters||[];var p;p=[];k=0;for(g=e.length;k<g;k++)m=e[k],p.push(a.parse(m));this.slicer=p;g=[];e=0;for(k=h.length;e<k;e++)m=h[e],g.push(a.parse(m));this.filters=g;this.measureNames=b.measure_names||[];this.levelCount=
0;k=[];g=h=0;for(e=b.axes.length;0<=e?h<e:h>e;g=0<=e?++h:--h)m=b.axes[g],g=Wonkavision.AXIS_NAMES[g],m=new j(g,this,m,this.levelCount),this.levelCount=m.endIndex+1,k.push(m);this.axes=k;this.cells={};this.totals=new c(this,b.totals);this.cells[this.totals.key]=this.totals;e=b.cells||[];m=0;for(h=e.length;m<h;m++)k=e[m],k=new c(this,k),this.cells[k.key]=k;g=Wonkavision.AXIS_NAMES;h=e=0;for(k=g.length;e<k;h=++e)m=g[h],this[m]=this.axes[h]};d.prototype.cell=function(){var a,b;b=function(){var b,c,d;
if("undefined"!==typeof a&&null!==a)return a.toString();d=[];b=0;for(c=arguments.length;b<c;b++)a=arguments[b],d.push(a);return d}.apply(this,arguments);return this.cells[b]||new c(this)};b.Cellset=d}).call(this);
(function(){var j=this.Wonkavision,c=function(a){null==a&&(a={});a=_.defaults(a,{windowSize:30,windowType:"days",calculation:"average",transformation:function(a){return a},injectMissingDates:!0,treatNullsAsZero:!0});this.windowSize=a.windowSize;this.windowType=a.windowType;this.calculation=a.calculation;this.injectMissingDates=a.injectMissingDates;this.transformation=a.transformation;this.treatNullsAsZero=a.treatNullsAsZero;this.reset()};c.prototype.add=function(a,b){a=moment(a);this.currentDate||
(this.currentDate=a);this.advanceTo(a);this.addSample(b);return this};c.prototype.reset=function(){this.samples=[];this.values=[];this.currentDate=null;return this};c.prototype.advanceTo=function(a){var b;a=moment(a);for(b=[];null!=this.currentDate&&this.currentDate<a;)b.push(this.skip());return b};c.prototype.skip=function(){return this.injectMissingDates?this.addSample(null):this.advance()};c.prototype.advance=function(){return this.currentDate.add(this.windowType,1)};c.prototype.addSample=function(a){this.samples.unshift(a);
this.samples.length>this.windowSize&&this.samples.pop();this.values.push([1E3*this.currentDate.clone().unix(),this.currentValue()]);return this.advance()};c.prototype.currentValue=function(){var a,b;b=_.reduce(this.samples,function(a,b){return a+(b||0)},0);a=this.treatNullsAsZero?this.samples.length:_.compact(this.samples.slice(0)).length;a="average"===this.calculation?b/a:b;return("function"===typeof this.transformation?this.transformation(a):void 0)||a};j.MovingCalculation=c}).call(this);
(function(){var j,c=function(a){this.extractArgs(a);this.palette=new Rickshaw.Color.Palette({scheme:this.colorScheme})};c.prototype.renderGraph=function(a,b){var c,f,l,j=this;f=_.map(a,function(a){return{name:a.name,color:j.colorFor(a.name),data:a.data}});c=b.append("div").attr("class","wv-chart");l=b.append("div").attr("class","wv-y-axis");c=new Rickshaw.Graph(_.extend(this.graphArgs,{element:c[0][0],series:f}));new Rickshaw.Graph.Axis.Time(_.extend(this.xAxisArgs,{graph:c}));new Rickshaw.Graph.Axis.Y(_.extend(this.yAxisArgs,
{graph:c,element:l[0][0]}));new Rickshaw.Graph.HoverDetail(_.extend(this.hoverArgs,{graph:c}));return c.render()};c.prototype.colorFor=function(a){var b;this.colorCache||(this.colorCache={});return(b=this.colorCache)[a]||(b[a]=this.palette.color())};c.prototype.extractArgs=function(a){this.colorScheme=a.palette||a.colorScheme||this.colorScheme||"munin";this.graphArgs=_.defaults(a.graph||{},{width:300,height:300,renderer:"line"});this.xAxisArgs=a.xAxis||{};this.yAxisArgs=_.defaults(a.yAxis||{},{orientation:"left",
tickFormat:Rickshaw.Fixtures.Number.formatKMBT});return this.hoverArgs=a.hover||{}};(j=this.Wonkavision).renderers||(j.renderers={});this.Wonkavision.renderers.Rickshaw=c}).call(this);
(function(){var j,c=function(a){this.extractArgs(a)};c.prototype.renderGraph=function(a,b){var c;c=b.append("div").attr("class","wv-chart");c=_.extend(this.chartArgs,{series:a,chart:_.extend(this.chartArgs.chart,{renderTo:c[0][0]})});return new Highcharts.Chart(c)};c.prototype.extractArgs=function(a){var b,c,f,l,j,k,h,g,e,p,n,q,r,s,t;this.chartArgs=a.highchart||{};this.chartArgs.chart=_.defaults(this.chartArgs.chart||{},{borderColor:"#CCC",type:"line",backgroundColor:"white",spacingBottom:10,spacingTop:10});
this.chartArgs.tooltip=_.defaults(this.chartArgs.tooltip||{},{shared:!0});this.chartArgs.plotOptions=_.extend(this.chartArgs.plotOptions||{},{series:_.defaults((null!=(b=this.chartArgs.plotOptions)?b.series:void 0)||{},{animation:!1}),line:_.defaults((null!=(c=this.chartArgs.plotOptions)?c.line:void 0)||{},{marker:_.defaults((null!=(g=this.chartArgs.plotOptions)?null!=(e=g.line)?e.marker:void 0:void 0)||{},{enabled:!1}),shadow:!1}),column:_.defaults((null!=(p=this.chartArgs.plotOptions)?p.column:
void 0)||{},{shadow:!1}),bar:_.defaults((null!=(n=this.chartArgs.plotOptions)?n.bar:void 0)||{},{shadow:!1}),spline:_.defaults((null!=(q=this.chartArgs.plotOptions)?q.spline:void 0)||{},{marker:_.defaults((null!=(r=this.chartArgs.plotOptions)?null!=(s=r.spline)?s.marker:void 0:void 0)||{},{enabled:!1}),shadow:!1}),area:_.defaults((null!=(t=this.chartArgs.plotOptions)?t.area:void 0)||{},{marker:_.defaults((null!=(f=this.chartArgs.plotOptions)?null!=(l=f.area)?l.marker:void 0:void 0)||{},{enabled:!1}),
shadow:!1}),areaspline:_.defaults((null!=(j=this.chartArgs.plotOptions)?j.areaspline:void 0)||{},{marker:_.defaults((null!=(k=this.chartArgs.plotOptions)?null!=(h=k.areaspline)?h.marker:void 0:void 0)||{},{enabled:!1}),shadow:!1})});this.chartArgs.xAxis=_.defaults(this.chartArgs.xAxis||{},{type:"datetime"});return this.chartArgs.yAxis=_.defaults(this.chartArgs.yAxis||{},{endOnTick:!1})};(j=this.Wonkavision).renderers||(j.renderers={});this.Wonkavision.renderers.Highcharts=c}).call(this);
(function(){var j;j=this.Wonkavision.Utilities;var c=this.Wonkavision,a=function(a){_.bindAll(this,"render","renderTable","renderColumnHeaders","renderTableData");this.extractArgs(a)};a.prototype.render=function(a){this.extractArgs(a);this.pivot="text"===this.viewType?new Wonkavision.PivotTable(this.data,a):new Wonkavision.ChartTable(this.data,a);this.pivot.isFlat&&"text"===this.viewType&&this.pivot.pivot();this.dataTable=this.pivot.createDataTable();null==this.suppressMeasureHeaders&&(this.suppressMeasureHeaders=
2>this.pivot.cellset.measureNames.length);return this.element.append("table").attr("class","wv-pivot-table").call(this.renderTable)};a.prototype.extractArgs=function(a){a.data&&(this.data=a.data);a.element&&(this.element=d3.selectAll(a.element));this.viewType=a.viewType||a.view||this.detectViewType(a);this.renderer="text"===this.viewType?a.cellRenderer:this.createRenderer(a);this.formatLabel=a.formatLabel||function(a){return a};this.formatData=a.formatData||function(a){return null!=a.formattedValue?
a.formattedValue:"-"};this.formatCell=a.formatCell||function(a,b,c){return c};if(this.smooth=a.smooth)this.smoothingMethod=a.smoothingMethod,this.smoothingWindow=a.smoothingWindow||30,this.smoothingPeriod=a.smoothingPeriod||"days",this.smoothingTransformation=a.smoothingTransformation||null,this.smoothingTreatNullsAsZero=null!=a.smoothingTreatNullsAsZero?a.smoothingTreatNullsAsZero:!0;this.suppressMeasureHeaders=a.suppressMeasureHeaders;this.suppressAllHeaders=a.suppressAllHeaders;return this.seriesTransformation=
a.seriesTransformation};a.prototype.createRenderer=function(a){return new (a.renderer||Wonkavision.renderers["default"]||Wonkavision.renderers.Rickshaw)(a)};a.prototype.memberSpan=function(a){var c;return null!=(c=a.members)?c.nonEmpty().leaves().length:void 0};a.prototype.renderTable=function(a){this.dataRows=[];this.table=a;this.table.call(this.renderColumnHeaders);return this.table.call(this.renderTableData)};a.prototype.renderColumnHeaders=function(a){var c,f=this;if(this.pivot.isFlat&&"rows"===
this.pivot.measuresAxis)return c=_.map(this.pivot.axes[0].dimensions,function(a){return a.name}),c=c.concat(this.pivot.cellset.measureNames),a=a.append("thead"),a=a.append("tr").classed("wv-col",!0),a.selectAll("th.wv-col-header").data(c).enter().append("th").text(function(a){return f.formatLabel(a)});c=this.dataTable.columnMembers;a=a.append("thead");c=a.selectAll("tr.wv-col").data(this.filterColHeaders(c)).enter().append("tr").attr("class","wv-col");a=this.pivot.rows.dimensions.length+("rows"===
this.pivot.measuresAxis&&!this.suppressMeasureHeaders?1:0);c.append("th").attr("colspan",a);return c.selectAll("th.wv-col-header").data(function(a){return a},function(a){return a.key.toString()}).enter().append("th").text(function(a){return f.formatLabel(a.caption)}).attr("colspan",function(a){return f.memberSpan(a)}).attr("class","wv-col-header").classed("wv-totals",function(a){return a.totals})};a.prototype.renderTableData=function(a){var c,f=this;a=a.append("tbody").selectAll("tr.wv-row").data(this.dataTable.rows).enter().append("tr").classed("wv-row",
!0).classed("wv-totals",function(a){return a.totalsRow});a.selectAll("th.wv-row-header").data(function(a){return f.filterRowHeaders(a.rowMembers)},function(a){return a.key.toString()}).enter().append("th").text(function(a){return f.formatLabel(a.caption)}).attr("rowspan",function(a){return f.memberSpan(a)}).attr("class","wv-row-header").classed("wv-totals",function(a){return a.totals});c=this;a=a.selectAll("td.wv-cell").data(function(a){return a.cells}).enter().append("td").classed("wv-cell",!0).classed("wv-totals",
function(a){return a.totalsCell});return"text"===this.viewType?a.each(function(a,b){return c.renderCell(a,b,this)}):a.each(function(a,b){return c.renderGraph(a,b,this)})};a.prototype.filterRowHeaders=function(a){if(this.suppressAllHeaders)return[];if(1>a.length)return a;null!=_.last(a).isMeasure&&this.suppressMeasureHeaders&&(a=a.slice(0,-1));return a};a.prototype.filterColHeaders=function(a){return this.suppressAllHeaders?[]:this.suppressMeasureHeaders&&"columns"===this.pivot.measuresAxis?a.slice(0,
-1):a};a.prototype.renderCell=function(a,c,f){var j=this;this.renderer||(this.renderer=function(a,b,c){var d;return j.formatCell(d3.select(c).attr("data-wv-filters",null!=(d=a.cell)?d.filters.join(","):void 0).text(function(a){return j.formatData(a)}))});return this.renderer(a,c,f)};a.prototype.renderGraph=function(a,c,f){a=this.prepareSeries(a.series);f=d3.select(f).append("div").attr("class","wv-chart-container");return this.renderer.renderGraph(a,f)};a.prototype.detectViewType=function(a){return null!=
a.seriesSource||null!=a.seriesFrom?"chart":"text"};a.prototype.prepareSeries=function(a){var c=this;a=_.map(a,function(a){return{name:c.formatLabel(a.name),data:c.prepareSeriesData(a.data)}});return null!=this.seriesTransformation?this.seriesTransformation(a):a};a.prototype.prepareSeriesData=function(a){var c=this;a=_.map(a,function(a){return{x:c.keyToDate(a.x),y:parseFloat(a.y)||0}});return null!=this.smoothingMethod?j.smoothSeries(a,{windowSize:this.smoothingWindow,windowType:this.smoothingPeriod,
calculation:this.smoothingMethod,transformation:this.smoothingTransformation,treatNullsAsZero:this.smoothingTreatNullsAsZero}):a};a.prototype.keyToDate=function(a){return 1E3*j.keyToDate(a,!1).unix()};c.PivotTableView=a}).call(this);
